<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Defense Forum - Gestion des Tickets</title>
<style>
  :root {
    --bg: #0f0f1a;
    --card: #1a1a2e;
    --accent: #5865f2;
    --accent-dark: #4752c4;
    --danger: #dc3545;
    --text: #e0e0ff;
    --text-muted: #a0a0cc;
    --border: #2a2a44;
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
    display: flex;
    justify-content: center;
  }
  .box {
    background: var(--card);
    padding: 32px;
    width: 100%;
    max-width: 820px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    border: 1px solid var(--border);
  }
  h2, h3 { color: white; margin-bottom: 16px; }
  h2 { font-size: 1.9rem; }
  h3 { font-size: 1.4rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    margin: 8px 0;
    background: #111122;
    color: white;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 1rem;
  }
  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(88,101,242,0.25);
  }
  button {
    padding: 12px 24px;
    margin: 8px 6px 8px 0;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }
  button:hover { background: var(--accent-dark); transform: translateY(-1px); }
  button.delete { background: var(--danger); }
  button.delete:hover { background: #c82333; }
  button.logs { background: #6c757d; }
  button.logs:hover { background: #5a6268; }
  .hidden { display: none; }
  .link { color: var(--accent); cursor: pointer; text-decoration: underline; font-size: 0.95rem; margin-top: 8px; display: inline-block; }
  .ticket { background: #141426; padding: 18px; margin: 16px 0; border-radius: 10px; border: 1px solid var(--border); }
  .messages { background: #0d0d18; padding: 12px; margin: 12px 0 16px; border-radius: 8px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); }
  .message { margin-bottom: 10px; padding: 10px 12px; border-radius: 6px; background: #1e1e30; }
  .message-header { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; }
  .officier { background: rgba(0,71,171,0.5); }
  .sergent  { background: rgba(0,100,0,0.5); }
  .soldat   { background: rgba(139,69,19,0.5); }
  .log-entry { padding: 12px 16px; background: #111122; border-radius: 6px; margin: 10px 0; border-left: 4px solid var(--accent); font-size: 0.94rem; }
  .log-entry.delete { border-left-color: var(--danger); }
  .log-entry small { color: var(--text-muted); float: right; font-size: 0.85rem; }
</style>
</head>
<body>

<div class="box">
  <h2 id="title">Connexion</h2>

  <div id="loginBox">
    <input type="text" id="loginUsername" placeholder="Username">
    <input type="password" id="loginPassword" placeholder="Mot de passe">
    <button onclick="login()">Se connecter</button>
    <p class="link" onclick="showRegister()">Pas de compte ? S'inscrire</p>
  </div>

  <div id="registerBox" class="hidden">
    <input type="text" id="regNom" placeholder="Nom">
    <input type="text" id="regPrenom" placeholder="Prénom">
    <input type="text" id="regUsername" placeholder="Username">
    <input type="password" id="regPassword" placeholder="Mot de passe">
    <button onclick="register()">Créer un compte</button>
    <p class="link" onclick="showLogin()">Déjà un compte ? Se connecter</p>
  </div>

  <div id="dashboard" class="hidden">
    <h3>Bienvenue, <span id="userDisplay"></span></h3>
    <p>Rôle : <span id="roleDisplay"></span></p>
    <button onclick="logout()">Déconnexion</button>

    <hr style="border-color:var(--border); margin:24px 0;">

    <h3>Créer un ticket</h3>
    <input type="text" id="ticketNom" placeholder="Nom">
    <input type="text" id="ticketPrenom" placeholder="Prénom">
    <select id="ticketRaison">
      <option value="Recrutement">Recrutement</option>
      <option value="Question Officier">Question Officier</option>
      <option value="Rapport Interne">Rapport Interne</option>
      <option value="Permis avion / PPL">Permis avion / PPL</option>
      <option value="Rejoindre une composante">Rejoindre une composante</option>
    </select>
    <button onclick="createTicket()">Créer Ticket</button>

    <hr style="border-color:var(--border); margin:28px 0 20px;">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3>Tickets</h3>
      <button class="logs" id="logsBtn" style="display:none;" onclick="toggleLogs()">Voir les Logs</button>
    </div>

    <div id="ticketsContainer"></div>

    <div id="logsSection" class="hidden">
      <h3>Historique des actions</h3>
      <div id="logsContainer"></div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://gktawbaposndfxijkxdk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk"
)

const getCurrentUser = () => JSON.parse(localStorage.getItem("user") || "null");

// UI toggles
window.showRegister = () => {
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("registerBox").classList.remove("hidden");
  document.getElementById("title").innerText = "Inscription";
};

window.showLogin = () => {
  document.getElementById("registerBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
  document.getElementById("title").innerText = "Connexion";
};

// Register
window.register = async () => {
  const nom = document.getElementById("regNom").value.trim();
  const prenom = document.getElementById("regPrenom").value.trim();
  const username = document.getElementById("regUsername").value.trim();
  const password = document.getElementById("regPassword").value.trim();

  if (!nom || !prenom || !username || !password) return alert("Tous les champs sont requis");

  const { data: existing } = await supabase.from("profiles").select("id").eq("username", username).maybeSingle();
  if (existing) return alert("Ce nom d'utilisateur est déjà pris");

  const { error } = await supabase.from("profiles").insert({ nom, prenom, username, password, role: "user" });
  if (error) return alert("Erreur création compte : " + error.message);

  alert("Compte créé ! Connectez-vous.");
  showLogin();
};

// Login
window.login = async () => {
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  const { data, error } = await supabase
    .from("profiles")
    .select("*")
    .eq("username", username)
    .eq("password", password)
    .maybeSingle();

  if (error || !data) return alert("Identifiants incorrects");

  localStorage.setItem("user", JSON.stringify(data));
  showDashboard(data);
};

function showDashboard(user) {
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("registerBox").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
  document.getElementById("userDisplay").innerText = user.username;
  document.getElementById("roleDisplay").innerText = user.role;

  if (user.role === "officier") {
    document.getElementById("logsBtn").style.display = "block";
  }

  loadTickets();
}

window.logout = () => {
  localStorage.removeItem("user");
  location.reload();
};

// Helper log (INSERT autorisé via RLS anon)
async function addLog(action, details = {}) {
  const user = getCurrentUser();
  const payload = {
    actor_id: user?.id || null,
    action,
    details: details ? JSON.stringify(details) : null
  };

  const { error } = await supabase.from("logs").insert(payload);
  if (error) console.warn("Log non enregistré :", error.message);
}

// Tickets
window.createTicket = async () => {
  const user = getCurrentUser();
  if (!user) return alert("Connecte-toi");

  const nom = document.getElementById("ticketNom").value.trim();
  const prenom = document.getElementById("ticketPrenom").value.trim();
  const raison = document.getElementById("ticketRaison").value;

  if (raison === "Rejoindre une composante" && !["soldat","sergent","officier"].includes(user.role))
    return alert("Action non autorisée");

  if (!nom || !prenom) return alert("Nom et prénom requis");

  const { data, error } = await supabase.from("tickets").insert({
    user_id: user.id,
    nom, prenom, raison,
    status: "ouvert"
  }).select().single();

  if (error) return alert("Erreur création ticket : " + error.message);

  await addLog("ticket_created", { ticket_id: data.id, raison });

  document.getElementById("ticketNom").value = "";
  document.getElementById("ticketPrenom").value = "";
  loadTickets();
};

async function loadTickets() {
  const user = getCurrentUser();
  if (!user) return;

  let query = supabase.from("tickets")
    .select("*, profiles!user_id (nom, prenom, username)")
    .order("created_at", { ascending: false });

  if (user.role === "user" || user.role === "soldat") {
    query = query.eq("user_id", user.id);
  } else if (user.role === "sergent") {
    query = query.ilike("raison", "%Recrutement%");
  }

  const { data, error } = await query;
  const container = document.getElementById("ticketsContainer");
  container.innerHTML = error ? `<p style="color:#ff6b6b;">Erreur : ${error.message}</p>` : "";

  if (error || !data?.length) {
    container.innerHTML += "<p>Aucun ticket</p>";
    return;
  }

  data.forEach(ticket => {
    const div = document.createElement("div");
    div.className = "ticket";
    const creator = ticket.profiles || { nom: "?", prenom: "?", username: "?" };

    div.innerHTML = `
      <strong>${ticket.raison}</strong><br>
      <small style="color:var(--text-muted)">${creator.nom} ${creator.prenom} (${creator.username}) • ${ticket.status}</small>
      <div class="messages" id="messages-${ticket.id}"></div>
      <textarea id="msg-${ticket.id}" placeholder="Répondre..."></textarea>
      <div style="margin-top:10px;">
        <button onclick="sendMessage('${ticket.id}')">Envoyer</button>
        ${user.role === "officier" ? `<button class="delete" onclick="deleteTicket('${ticket.id}')">Supprimer</button>` : ""}
      </div>
    `;
    container.appendChild(div);
    loadMessages(ticket.id);
  });
}

window.deleteTicket = async (ticketId) => {
  if (!confirm("Supprimer définitivement ce ticket ?")) return;

  await supabase.from("messages").delete().eq("ticket_id", ticketId);

  const { error } = await supabase.from("tickets").delete().eq("id", ticketId);
  if (error) return alert("Erreur suppression : " + error.message);

  await addLog("ticket_deleted", { ticket_id: ticketId });

  alert("Ticket supprimé");
  loadTickets();
  if (!document.getElementById("logsSection").classList.contains("hidden")) loadLogs();
};

// Messages
window.sendMessage = async (ticketId) => {
  const user = getCurrentUser();
  const textarea = document.getElementById(`msg-${ticketId}`);
  const content = textarea.value.trim();
  if (!content) return;

  const { data: ticket, error: err } = await supabase.from("tickets").select("user_id").eq("id", ticketId).single();
  if (err || !ticket) return alert("Ticket introuvable");

  if (ticket.user_id !== user.id && user.role !== "officier") {
    return alert("Non autorisé");
  }

  const { error } = await supabase.from("messages").insert({
    ticket_id: ticketId,
    sender_id: user.id,
    content
  });

  if (error) return alert("Erreur envoi message : " + error.message);

  await addLog("message_sent", { ticket_id: ticketId, content: content.slice(0, 80) + "..." });

  textarea.value = "";
  loadMessages(ticketId);
};

async function loadMessages(ticketId) {
  const container = document.getElementById(`messages-${ticketId}`);
  container.innerHTML = "";

  // On évite le join complexe qui cause 400 → on charge messages puis profiles séparément
  const { data: messages, error } = await supabase
    .from("messages")
    .select("*")
    .eq("ticket_id", ticketId)
    .order("created_at");

  if (error || !messages?.length) return;

  for (const msg of messages) {
    const { data: sender } = await supabase
      .from("profiles")
      .select("nom, prenom, role")
      .eq("id", msg.sender_id)
      .single();

    const s = sender || { nom: "?", prenom: "?", role: "user" };

    let roleLabel = "", roleClass = "user";
    if (s.role === "officier") { roleLabel = "[OFFICIER]"; roleClass = "officier"; }
    else if (s.role === "sergent") { roleLabel = "[SERGENT]"; roleClass = "sergent"; }
    else if (s.role === "soldat") { roleLabel = "[SOLDAT]"; roleClass = "soldat"; }

    const date = new Date(msg.created_at).toLocaleString("fr-FR", {dateStyle: "short", timeStyle: "short"});

    const div = document.createElement("div");
    div.className = `message ${roleClass}`;
    div.innerHTML = `<div class="message-header">${s.nom} ${s.prenom} ${roleLabel} • ${date}</div>${msg.content}`;
    container.appendChild(div);
  }
}

// Logs
async function loadLogs() {
  const container = document.getElementById("logsContainer");
  container.innerHTML = "Chargement...";

  const { data, error } = await supabase
    .from("logs")
    .select("*, profiles!actor_id (username, nom, prenom)")
    .order("created_at", { ascending: false })
    .limit(50);

  container.innerHTML = "";

  if (error) {
    container.innerHTML = `<p style="color:#ff6b6b;">Erreur logs : ${error.message}</p>`;
    return;
  }

  if (!data?.length) {
    container.innerHTML = "<p>Aucune activité récente</p>";
    return;
  }

  data.forEach(log => {
    const actor = log.profiles || { nom: "?", prenom: "?", username: "?" };
    const date = new Date(log.created_at).toLocaleString("fr-FR");
    const details = log.details ? JSON.parse(log.details) : {};
    let text = `${log.action} par ${actor.nom} ${actor.prenom} (${actor.username || "?"})`;

    if (log.action === "ticket_created") text += ` — ${details.raison || "?"}`;
    if (log.action === "ticket_deleted") text += ` — Ticket ${details.ticket_id}`;
    if (log.action === "message_sent") text += ` — sur ticket ${details.ticket_id}`;

    const div = document.createElement("div");
    div.className = `log-entry ${log.action.includes("delete") ? "delete" : ""}`;
    div.innerHTML = `${text} <small>${date}</small>`;
    container.appendChild(div);
  });
}

window.toggleLogs = () => {
  const section = document.getElementById("logsSection");
  section.classList.toggle("hidden");
  if (!section.classList.contains("hidden")) loadLogs();
};

// Auto-login
const savedUser = localStorage.getItem("user");
if (savedUser) showDashboard(JSON.parse(savedUser));
</script>
</body>
</html>
