<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Defense Forum - Tickets avec Rôles et Messages</title>
<style>
body { font-family: Arial; background:#1e1e2f; color:white; display:flex; justify-content:center; }
.box { background:#2c2c3f; padding:30px; width:700px; border-radius:10px; margin-top:20px; }
input, select, textarea { width:100%; padding:8px; margin:5px 0; background:#1a1a28; color:white; border:1px solid #444; }
button { padding:10px; margin:5px 0; background:#5865F2; color:white; border:none; cursor:pointer; }
.hidden { display:none; }
.ticket { background:#2c2c3f; padding:15px; margin:10px 0; border-radius:8px; }
.messages { background:#1a1a28; padding:10px; margin-top:5px; border-radius:6px; max-height:150px; overflow-y:auto; }
.message { margin-bottom:5px; padding:5px; border-radius:5px; }
.message-header { font-size:12px; color:#aaa; margin-bottom:3px; }
.officier { background:#0047AB; }
.sergent { background:#006400; }
.soldat { background:#8B4513; }
.user { background:#333; }
.link { color:#58a6ff; cursor:pointer; font-size:14px; }
</style>
</head>
<body>
<div class="box">

<h2 id="title">Connexion</h2>

<!-- LOGIN -->
<div id="loginBox">
  <input type="text" id="loginUsername" placeholder="Username">
  <input type="password" id="loginPassword" placeholder="Mot de passe">
  <button onclick="login()">Se connecter</button>
  <p class="link" onclick="showRegister()">Pas de compte ? S'inscrire</p>
</div>

<!-- REGISTER -->
<div id="registerBox" class="hidden">
  <input type="text" id="regNom" placeholder="Nom">
  <input type="text" id="regPrenom" placeholder="Prénom">
  <input type="text" id="regUsername" placeholder="Username">
  <input type="password" id="regPassword" placeholder="Mot de passe">
  <button onclick="register()">Créer un compte</button>
  <p class="link" onclick="showLogin()">Déjà un compte ? Se connecter</p>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
  <h3>Bienvenue <span id="userDisplay"></span></h3>
  <p>Rôle : <span id="roleDisplay"></span></p>
  <button onclick="logout()">Déconnexion</button>

  <hr>
  <h3>Créer un ticket</h3>
  <input type="text" id="ticketNom" placeholder="Nom">
  <input type="text" id="ticketPrenom" placeholder="Prénom">
  <select id="ticketRaison">
    <option value="Recrutement">Recrutement</option>
    <option value="Question Officier">Question Officier</option>
    <option value="Rapport Interne">Rapport Interne</option>
    <option value="Permis avion / PPL">Permis avion / PPL</option>
    <option value="Rejoindre une composante">Rejoindre une composante</option>
  </select>
  <button onclick="createTicket()">Créer Ticket</button>

  <hr>
  <h3>Tickets</h3>
  <div id="ticketsContainer"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
const supabase = createClient("https://gktawbaposndfxijkxdk.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk")

// ===== UI =====
window.showRegister = function() {
  document.getElementById("loginBox").classList.add("hidden")
  document.getElementById("registerBox").classList.remove("hidden")
  document.getElementById("title").innerText = "Inscription"
}
window.showLogin = function() {
  document.getElementById("registerBox").classList.add("hidden")
  document.getElementById("loginBox").classList.remove("hidden")
  document.getElementById("title").innerText = "Connexion"
}

// ===== REGISTER =====
window.register = async function() {
  const nom = document.getElementById("regNom").value.trim();
  const prenom = document.getElementById("regPrenom").value.trim();
  const username = document.getElementById("regUsername").value.trim();
  const password = document.getElementById("regPassword").value.trim();
  if(!nom || !prenom || !username || !password){ alert("Remplis tous les champs"); return; }

  const { data: existing } = await supabase.from("profiles").select("id").eq("username", username);
  if(existing.length>0){ alert("Username déjà utilisé"); return; }

  const { error } = await supabase.from("profiles").insert([{ nom, prenom, username, password, role:"user" }]);
  if(error){ alert("Erreur création compte: "+error.message); } 
  else { alert("Compte créé ! Connecte-toi."); showLogin(); }
}

// ===== LOGIN =====
window.login = async function() {
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  const { data, error } = await supabase.from("profiles").select("*").eq("username", username).eq("password", password);
  if(error){ alert("Erreur login"); return; }
  if(!data || data.length===0){ alert("Identifiants incorrects"); return; }
  const user = data[0]; localStorage.setItem("user", JSON.stringify(user)); showDashboard(user);
}

// ===== DASHBOARD =====
function showDashboard(user){
  document.getElementById("loginBox").classList.add("hidden")
  document.getElementById("registerBox").classList.add("hidden")
  document.getElementById("dashboard").classList.remove("hidden")
  document.getElementById("userDisplay").innerText=user.username
  document.getElementById("roleDisplay").innerText=user.role
  loadTickets()
}
window.logout = function(){ localStorage.removeItem("user"); location.reload() }

// ===== TICKETS =====
window.createTicket = async function(){
  const user = JSON.parse(localStorage.getItem("user"))
  if(!user){ alert("Connecte-toi"); return; }

  const nom = document.getElementById("ticketNom").value.trim();
  const prenom = document.getElementById("ticketPrenom").value.trim();
  const raison = document.getElementById("ticketRaison").value;

  if(raison==="Rejoindre une composante" && !["soldat","sergent","officier"].includes(user.role)){
    alert("Tu n'as pas le droit de créer ce ticket"); return;
  }

  if(!nom || !prenom){ alert("Remplis nom et prénom"); return; }

  const { error } = await supabase.from("tickets").insert([{ user_id:user.id, nom, prenom, raison, status:"ouvert" }]);
  if(error){ alert("Erreur création ticket: "+error.message); return; }

  document.getElementById("ticketNom").value=""
  document.getElementById("ticketPrenom").value=""
  loadTickets()
}

async function loadTickets(){
  const user = JSON.parse(localStorage.getItem("user"))
  let query = supabase.from("tickets").select("*").order("created_at",{ascending:false})

  if(user.role==="user" || user.role==="soldat"){ query = query.eq("user_id",user.id) }
  else if(user.role==="sergent"){ query = query.ilike("raison","%Recrutement%") } // voit tous les tickets de recrutement/composante

  const { data, error } = await query
  const container = document.getElementById("ticketsContainer")
  container.innerHTML=""
  if(error){ container.innerText="Erreur chargement tickets"; return; }
  if(!data || data.length===0){ container.innerText="Pas de tickets"; return; }

  data.forEach(ticket=>{
    const div = document.createElement("div")
    div.className="ticket"
    div.innerHTML=`
      <b>${ticket.raison}</b> - Status: ${ticket.status}<br>
      ${ticket.nom} ${ticket.prenom}<br>
      <div class="messages" id="messages-${ticket.id}"></div>
      <textarea id="msg-${ticket.id}" placeholder="Répondre..."></textarea>
      <button onclick="sendMessage('${ticket.id}')">Envoyer</button>
    `
    container.appendChild(div)
    loadMessages(ticket.id)
  })
}

// ===== MESSAGES =====
window.sendMessage = async function(ticketId){
  const user = JSON.parse(localStorage.getItem("user"))
  const textarea = document.getElementById("msg-"+ticketId)
  const content = textarea.value.trim()
  if(!content) return

  const { data: ticketData } = await supabase.from("tickets").select("*").eq("id",ticketId)
  const ticket = ticketData[0]
  if(ticket.user_id!==user.id && user.role!=="officier"){ alert("Tu ne peux pas répondre à ce ticket"); return }

  await supabase.from("messages").insert([{ ticket_id:ticketId, sender_id:user.id, content }])
  textarea.value=""
  loadMessages(ticketId)
}

async function loadMessages(ticketId){
  const { data } = await supabase.from("messages").select("*, sender:profiles(*)").eq("ticket_id", ticketId).order("created_at",{ascending:true})
  const container = document.getElementById("messages-"+ticketId)
  container.innerHTML=""
  if(!data) return

  data.forEach(msg=>{
    const sender = msg.sender
    let roleLabel="", roleClass="user"
    if(sender.role==="officier"){ roleLabel="[CORPS DES OFFICIERS]"; roleClass="officier" }
    else if(sender.role==="sergent"){ roleLabel="[CORPS D'ENCADREMENT]"; roleClass="sergent" }
    else if(sender.role==="soldat"){ roleLabel="[Soldat]"; roleClass="soldat" }
    else{ roleLabel=""; roleClass="user" }

    const date = new Date(msg.created_at).toLocaleString()
    const messageDiv = document.createElement("div")
    messageDiv.className = "message "+roleClass
    messageDiv.innerHTML = `<div class="message-header">${sender.nom} ${sender.prenom} ${roleLabel} - ${date}</div>${msg.content}`
    container.appendChild(messageDiv)
  })
}

// ===== AUTO LOGIN =====
const savedUser = localStorage.getItem("user")
if(savedUser){ showDashboard(JSON.parse(savedUser)) }

</script>
</body>
</html>
