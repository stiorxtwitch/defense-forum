<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Defense Forum - Tickets</title>

<style>
body {
  font-family: Arial;
  background:#1e1e2f;
  color:white;
}
.container {
  width: 900px;
  margin:auto;
}
button {
  padding:10px;
  background:#5865F2;
  color:white;
  border:none;
  margin:5px 0;
  cursor:pointer;
}
input, select, textarea {
  width:100%;
  padding:8px;
  margin:5px 0;
  background:#2c2c3f;
  color:white;
  border:1px solid #444;
}
.ticket {
  background:#2c2c3f;
  padding:15px;
  margin:15px 0;
  border-radius:8px;
}
.messages {
  background:#1a1a28;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
}
</style>
</head>
<body>

<div class="container">

<h1>ðŸŽ« Defense Forum - SystÃ¨me de Tickets</h1>

<button onclick="login()">Connexion Google</button>
<button onclick="logout()">DÃ©connexion</button>

<hr>

<h2>CrÃ©er un ticket</h2>

<form id="ticketForm">
  <input type="text" id="nom" placeholder="Nom" required>
  <input type="text" id="prenom" placeholder="PrÃ©nom" required>

  <select id="raison">
    <option value="Recrutement">Recrutement</option>
    <option value="Question Officier">Question Officier</option>
    <option value="Rapport Interne">Rapport Interne</option>
    <option value="Permis avion / PPL">Permis avion / PPL</option>
  </select>

  <button type="submit">CrÃ©er Ticket</button>
</form>

<hr>

<h2>Tickets</h2>
<div id="tickets"></div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://gktawbaposndfxijkxdk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk"
)

// ================= LOGIN / LOGOUT =================

window.login = async function () {
  await supabase.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: "http://localhost:3000"
    }
  })
}

window.logout = async function () {
  await supabase.auth.signOut()
  window.location.href = "http://localhost:3000"
}

// ================= UTILISATEUR =================

async function getUser() {
  const { data } = await supabase.auth.getUser()
  return data.user
}

async function createProfileIfNotExists(user) {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", user.id)

  if (!data || data.length === 0) {
    await supabase.from("profiles").insert({
      id: user.id,
      email: user.email,
      role: "user"
    })
  }
}

// ================= CREATION TICKET =================

document.getElementById("ticketForm").addEventListener("submit", async (e) => {
  e.preventDefault()

  const user = await getUser()
  if (!user) {
    alert("Connecte-toi d'abord.")
    return
  }

  const nom = document.getElementById("nom").value
  const prenom = document.getElementById("prenom").value
  const raison = document.getElementById("raison").value

  const { error } = await supabase.from("tickets").insert({
    user_id: user.id,
    nom,
    prenom,
    raison
  })

  if (error) {
    alert("Erreur : " + error.message)
  } else {
    alert("Ticket crÃ©Ã© avec succÃ¨s !")
    loadTickets()
  }
})

// ================= AFFICHAGE TICKETS =================

async function loadTickets() {
  const user = await getUser()
  if (!user) return

  const { data, error } = await supabase
    .from("tickets")
    .select("*")
    .order("created_at", { ascending: false })

  if (error) {
    console.error(error)
    return
  }

  const container = document.getElementById("tickets")
  container.innerHTML = ""

  data.forEach(ticket => {
    const div = document.createElement("div")
    div.className = "ticket"

    div.innerHTML = `
      <b>${ticket.raison}</b><br>
      ${ticket.nom} ${ticket.prenom}<br>
      Status: ${ticket.status}<br>

      <div class="messages" id="messages-${ticket.id}"></div>

      <textarea id="msg-${ticket.id}" placeholder="RÃ©pondre..."></textarea>
      <button onclick="sendMessage('${ticket.id}')">Envoyer</button>
    `

    container.appendChild(div)
    loadMessages(ticket.id)
  })
}

// ================= MESSAGES =================

window.sendMessage = async function(ticketId) {
  const user = await getUser()
  if (!user) return

  const textarea = document.getElementById("msg-"+ticketId)
  const content = textarea.value

  if (!content) return

  await supabase.from("messages").insert({
    ticket_id: ticketId,
    sender_id: user.id,
    content
  })

  textarea.value = ""
  loadMessages(ticketId)
}

async function loadMessages(ticketId) {
  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("ticket_id", ticketId)
    .order("created_at", { ascending: true })

  const container = document.getElementById("messages-"+ticketId)
  container.innerHTML = ""

  data.forEach(msg => {
    container.innerHTML += `<p>ðŸ’¬ ${msg.content}</p>`
  })
}

// ================= AUTH STATE =================

supabase.auth.onAuthStateChange(async () => {
  const user = await getUser()
  if (user) {
    await createProfileIfNotExists(user)
    loadTickets()
  }
})

// Nettoyage du hash aprÃ¨s login
if (window.location.hash.includes("access_token")) {
  window.history.replaceState({}, document.title, "/")
}

// Chargement initial
const user = await getUser()
if (user) {
  await createProfileIfNotExists(user)
  loadTickets()
}
</script>

</body>
</html>
