<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SystÃ¨me de Tickets</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial; background:#1e1e2f; color:white; }
.container { width: 800px; margin:auto; }
button { padding:10px; background:#5865F2; color:white; border:none; margin:5px 0; }
input, select, textarea {
  width:100%; padding:8px; margin:5px 0;
  background:#2c2c3f; color:white; border:1px solid #444;
}
.ticket { background:#2c2c3f; padding:10px; margin:10px 0; }
</style>
</head>
<body>

<div class="container">

<h1>ðŸŽ« SystÃ¨me de Tickets</h1>

<button onclick="login()">Connexion Google</button>
<button onclick="logout()">DÃ©connexion</button>

<h2>CrÃ©er un ticket</h2>

<form id="ticketForm">
  <input type="text" id="nom" placeholder="Nom" required>
  <input type="text" id="prenom" placeholder="PrÃ©nom" required>

  <select id="raison">
    <option value="Recrutement">Recrutement</option>
    <option value="Question Officier">Question Officier</option>
    <option value="Rapport Interne">Rapport Interne</option>
    <option value="Permis avion / PPL">Permis avion / PPL</option>
  </select>

  <button type="submit">CrÃ©er Ticket</button>
</form>

<h2>Mes Tickets</h2>
<div id="tickets"></div>

</div>

<script>
const supabase = window.supabase.createClient(
  "https://gktawbaposndfxijkxdk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk"
);

async function login() {
  await supabase.auth.signInWithOAuth({
    provider: 'google'
  });
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

async function getUser() {
  const { data: { user } } = await supabase.auth.getUser();
  return user;
}

async function createProfileIfNotExists(user) {
  const { data } = await supabase.from('profiles')
    .select("*").eq("id", user.id);

  if (!data.length) {
    await supabase.from('profiles').insert({
      id: user.id,
      email: user.email,
      role: "user"
    });
  }
}

document.getElementById("ticketForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const user = await getUser();
  if (!user) return alert("Connecte toi");

  const nom = document.getElementById("nom").value;
  const prenom = document.getElementById("prenom").value;
  const raison = document.getElementById("raison").value;

  const { error } = await supabase.from("tickets").insert({
    user_id: user.id,
    nom,
    prenom,
    raison
  });

  if (!error) {
    alert("Ticket crÃ©Ã© !");
    loadTickets();
  }
});

async function loadTickets() {
  const user = await getUser();
  if (!user) return;

  const { data } = await supabase.from("tickets").select("*");

  const container = document.getElementById("tickets");
  container.innerHTML = "";

  data.forEach(ticket => {
    const div = document.createElement("div");
    div.className = "ticket";
    div.innerHTML = `
      <b>${ticket.raison}</b><br>
      ${ticket.nom} ${ticket.prenom}<br>
      Status: ${ticket.status}<br>
      <textarea id="msg-${ticket.id}" placeholder="RÃ©pondre..."></textarea>
      <button onclick="sendMessage('${ticket.id}')">Envoyer</button>
      <div id="messages-${ticket.id}"></div>
    `;
    container.appendChild(div);
    loadMessages(ticket.id);
  });
}

async function sendMessage(ticketId) {
  const user = await getUser();
  const content = document.getElementById("msg-"+ticketId).value;

  await supabase.from("messages").insert({
    ticket_id: ticketId,
    sender_id: user.id,
    content
  });

  loadMessages(ticketId);
}

async function loadMessages(ticketId) {
  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("ticket_id", ticketId);

  const container = document.getElementById("messages-"+ticketId);
  container.innerHTML = "";

  data.forEach(msg => {
    container.innerHTML += `<p>${msg.content}</p>`;
  });
}

supabase.auth.onAuthStateChange(async () => {
  const user = await getUser();
  if (user) {
    await createProfileIfNotExists(user);
    loadTickets();
  }
});

</script>
</body>
</html>
