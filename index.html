<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Defense Forum - Auth Custom</title>

<style>
body {
  font-family: Arial;
  background:#1e1e2f;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.box {
  background:#2c2c3f;
  padding:30px;
  width:350px;
  border-radius:10px;
}
input {
  width:100%;
  padding:10px;
  margin:5px 0;
  background:#1a1a28;
  border:1px solid #444;
  color:white;
}
button {
  width:100%;
  padding:10px;
  background:#5865F2;
  border:none;
  color:white;
  margin-top:10px;
  cursor:pointer;
}
.link {
  color:#58a6ff;
  cursor:pointer;
  font-size:14px;
}
.hidden {
  display:none;
}
</style>
</head>
<body>

<div class="box">

<h2 id="title">Connexion</h2>

<!-- LOGIN -->
<div id="loginBox">
  <input type="text" id="loginUsername" placeholder="Username">
  <input type="password" id="loginPassword" placeholder="Mot de passe">
  <button onclick="login()">Se connecter</button>
  <p class="link" onclick="showRegister()">Pas de compte ? S'inscrire</p>
</div>

<!-- REGISTER -->
<div id="registerBox" class="hidden">
  <input type="text" id="regNom" placeholder="Nom">
  <input type="text" id="regPrenom" placeholder="Prénom">
  <input type="text" id="regUsername" placeholder="Username">
  <input type="password" id="regPassword" placeholder="Mot de passe">
  <button onclick="register()">Créer un compte</button>
  <p class="link" onclick="showLogin()">Déjà un compte ? Se connecter</p>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
  <h3>Bienvenue <span id="userDisplay"></span></h3>
  <p>Rôle : <span id="roleDisplay"></span></p>
  <button onclick="logout()">Déconnexion</button>
</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://gktawbaposndfxijkxdk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk"
)

// ================= UI =================

window.showRegister = function() {
  document.getElementById("loginBox").classList.add("hidden")
  document.getElementById("registerBox").classList.remove("hidden")
  document.getElementById("title").innerText = "Inscription"
}

window.showLogin = function() {
  document.getElementById("registerBox").classList.add("hidden")
  document.getElementById("loginBox").classList.remove("hidden")
  document.getElementById("title").innerText = "Connexion"
}

// ================= REGISTER =================

window.register = async function() {

  const nom = document.getElementById("regNom").value
  const prenom = document.getElementById("regPrenom").value
  const username = document.getElementById("regUsername").value
  const password = document.getElementById("regPassword").value

  if (!nom || !prenom || !username || !password) {
    alert("Remplis tous les champs")
    return
  }

  // Vérifier si username existe déjà
  const { data: existing } = await supabase
    .from("profiles")
    .select("*")
    .eq("username", username)

  if (existing.length > 0) {
    alert("Username déjà utilisé")
    return
  }

  // Créer profil
  const { error } = await supabase
    .from("profiles")
    .insert({
      nom,
      prenom,
      username,
      password,
      role: "user"
    })

  if (error) {
    alert("Erreur : " + error.message)
  } else {
    alert("Compte créé ! Connecte-toi.")
    showLogin()
  }
}

// ================= LOGIN =================

window.login = async function() {

  const username = document.getElementById("loginUsername").value
  const password = document.getElementById("loginPassword").value

  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("username", username)
    .eq("password", password)

  if (!data || data.length === 0) {
    alert("Identifiants incorrects")
    return
  }

  const user = data[0]

  // Stocker session local
  localStorage.setItem("user", JSON.stringify(user))

  showDashboard(user)
}

// ================= DASHBOARD =================

function showDashboard(user) {
  document.getElementById("loginBox").classList.add("hidden")
  document.getElementById("registerBox").classList.add("hidden")
  document.getElementById("dashboard").classList.remove("hidden")

  document.getElementById("userDisplay").innerText = user.username
  document.getElementById("roleDisplay").innerText = user.role
}

window.logout = function() {
  localStorage.removeItem("user")
  location.reload()
}

// ================= AUTO LOGIN =================

const savedUser = localStorage.getItem("user")
if (savedUser) {
  showDashboard(JSON.parse(savedUser))
}

</script>

</body>
</html>
